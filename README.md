# go-websocket-benchmark
- support 1m-connections client

## before running the test
- make sure setting the correct system env, for example:

```sh
sysctl -w net.ipv4.ip_local_port_range="1024 65535"
sysctl -w fs.file-max=2000500
sysctl -w fs.nr_open=2000500
sysctl -w net.nf_conntrack_max=2000500
ulimit -n 2000500
sysctl -w net.ipv4.tcp_mem='131072  262144  524288'
sysctl -w net.ipv4.tcp_rmem='8760  256960  4088000'
sysctl -w net.ipv4.tcp_wmem='8760  256960  4088000'
sysctl -w net.core.rmem_max=16384
sysctl -w net.core.wmem_max=16384
sysctl -w net.core.somaxconn=2048
sysctl -w net.ipv4.tcp_max_syn_backlog=2048
sysctl -w /proc/sys/net/core/netdev_max_backlog=2048
# sysctl -w net.ipv4.tcp_tw_recycle=1 # client nat tcp-handshak problem
sysctl -w net.ipv4.tcp_tw_reuse=1
```

## nbio 1m-connections-benchmark


run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/1m_conns_benchmark.sh
```

here is the result on my ubuntu vm:
```sh
--------------------------------------------------------------
BenchType  : BenchEcho
Framework  : nbio_nonblocking
TPS        : 79844
EER        : 256.63
Min        : 69.44us
Avg        : 623.21ms
Max        : 1.71s
TP50       : 581.32ms
TP75       : 796.61ms
TP90       : 813.17ms
TP95       : 823.89ms
TP99       : 844.41ms
Used       : 62.62s
Total      : 5000000
Success    : 5000000
Failed     : 0
Conns      : 1000000
Concurrency: 50000
Payload    : 1024
CPU Min    : 0.00%
CPU Avg    : 311.12%
CPU Max    : 388.90%
MEM Min    : 972.63M
MEM Avg    : 975.25M
MEM Max    : 978.77M
--------------------------------------------------------------
```

## benchmark for all frameworks
run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/benchmarkN.sh

# if you want to change the benchmark config, just read the script and edit:
# go-websocket-benchmark/script/config.sh
```

Some benchmark results:

----------------------------------------------------------------------------------------------------
20240215 06:43.02.844 [BenchEcho] Report

| Framework        | TPS    | EER    | Min     | Avg     | Max      | TP50    | TP75    | TP90    | TP95     | TP99     | Used   | Total   | Success | Failed | Conns | Concurrency | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | ------ | ------ | ------- | ------- | -------- | ------- | ------- | ------- | -------- | -------- | ------ | ------- | ------- | ------ | ----- | ----------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 315040 | 529.05 | 25.90us | 31.66ms | 224.28ms | 29.87ms | 32.13ms | 39.49ms | 40.77ms  | 44.23ms  | 6.35s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 225.82  | 595.48  | 676.52  | 246.90M | 251.98M | 257.06M |
| gobwas           | 243592 | 341.96 | 16.22us | 40.87ms | 243.87ms | 37.15ms | 48.13ms | 51.83ms | 54.15ms  | 74.07ms  | 8.21s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 161.69  | 712.34  | 793.69  | 355.88M | 356.13M | 357.64M |
| gorilla          | 314285 | 529.84 | 33.25us | 31.72ms | 136.04ms | 30.00ms | 32.16ms | 39.62ms | 40.76ms  | 43.35ms  | 6.36s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 237.88  | 593.17  | 673.81  | 247.31M | 252.65M | 257.93M |
| gws              | 321632 | 546.50 | 32.57us | 30.99ms | 171.29ms | 29.03ms | 31.34ms | 39.30ms | 40.98ms  | 45.35ms  | 6.22s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 130.94  | 588.54  | 690.85  | 152.56M | 161.02M | 165.52M |
| gws_std          | 325607 | 599.64 | 30.35us | 30.63ms | 90.03ms  | 28.91ms | 31.09ms | 38.54ms | 39.62ms  | 42.28ms  | 6.14s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 77.92   | 543.01  | 645.84  | 148.28M | 165.96M | 176.97M |
| hertz            | 162449 | 459.54 | 20.47ms | 61.34ms | 179.71ms | 55.79ms | 58.12ms | 99.28ms | 104.75ms | 112.25ms | 12.31s | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 117.85  | 353.51  | 393.89  | 459.61M | 515.86M | 566.73M |
| hertz_std        | 298720 | 499.18 | 32.66us | 33.39ms | 60.24ms  | 31.60ms | 33.96ms | 42.21ms | 43.65ms  | 45.84ms  | 6.70s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 0.00    | 598.42  | 740.83  | 321.94M | 327.67M | 333.06M |
| nbio_blocking    | 316234 | 545.89 | 22.40us | 31.54ms | 200.18ms | 29.63ms | 31.82ms | 39.70ms | 40.99ms  | 45.48ms  | 6.32s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 194.69  | 579.30  | 679.13  | 151.73M | 160.93M | 177.25M |
| nbio_mixed       | 318947 | 553.08 | 28.21us | 31.27ms | 220.66ms | 29.32ms | 31.70ms | 39.15ms | 40.61ms  | 50.70ms  | 6.27s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 166.80  | 576.68  | 666.57  | 168.16M | 199.56M | 213.57M |
| nbio_nonblocking | 201452 | 609.30 | 1.80ms  | 49.46ms | 112.92ms | 49.15ms | 50.95ms | 54.45ms | 58.81ms  | 73.48ms  | 9.93s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 0.00    | 330.63  | 372.95  | 42.55M  | 46.52M  | 48.20M  |
| nbio_std         | 319404 | 564.30 | 22.54us | 31.23ms | 222.69ms | 29.24ms | 31.39ms | 39.41ms | 40.79ms  | 45.35ms  | 6.26s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 165.87  | 566.02  | 658.85  | 172.36M | 175.95M | 177.04M |
| nettyws          | 318733 | 562.52 | 32.93us | 31.29ms | 94.20ms  | 29.55ms | 31.64ms | 39.36ms | 40.51ms  | 42.78ms  | 6.27s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 168.79  | 566.62  | 657.03  | 166.72M | 166.72M | 166.72M |
| nhooyr           | 259016 | 386.06 | 20.26us | 38.45ms | 135.07ms | 37.06ms | 39.69ms | 48.62ms | 51.20ms  | 70.35ms  | 7.72s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 0.00    | 670.92  | 801.33  | 367.87M | 380.07M | 391.41M |
| quickws          | 326105 | 621.77 | 31.96us | 30.57ms | 122.11ms | 28.77ms | 30.75ms | 38.55ms | 39.69ms  | 42.81ms  | 6.13s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 75.93   | 524.48  | 622.88  | 121.52M | 121.52M | 121.52M |
| greatws          | 305081 | 553.24 | 83.12us | 32.68ms | 231.50ms | 30.76ms | 32.74ms | 41.06ms | 42.54ms  | 63.75ms  | 6.56s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 318.47  | 551.45  | 627.77  | 44.68M  | 44.68M  | 44.68M  |
| greatws_event    | 317619 | 676.47 | 23.70us | 31.40ms | 226.43ms | 29.42ms | 32.78ms | 39.81ms | 41.35ms  | 46.72ms  | 6.30s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 149.93  | 469.52  | 561.73  | 47.11M  | 47.21M  | 47.36M  |
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
20240215 06:43.02.845 [BenchRate] Report

| Framework        | Duration | EchoEER | Packet Sent | Bytes Sent | Packet Recv | Bytes Recv | Conns | SendRate | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | -------- | ------- | ----------- | ---------- | ----------- | ---------- | ----- | -------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 10.00s   | 1303.95 | 10504880    | 10.02G     | 10274900    | 9.80G      | 10000 | 200      | 1024    | 772.78  | 787.98  | 806.07  | 274.82M | 287.04M | 298.00M |
| gobwas           | 10.00s   | 822.26  | 6597520     | 6.29G      | 6266614     | 5.98G      | 10000 | 200      | 1024    | 726.74  | 762.12  | 781.81  | 539.45M | 559.34M | 593.48M |
| gorilla          | 10.00s   | 1294.10 | 10419530    | 9.94G      | 10183060    | 9.71G      | 10000 | 200      | 1024    | 782.76  | 786.89  | 789.31  | 275.04M | 307.85M | 340.74M |
| gws              | 10.00s   | 1284.50 | 10313580    | 9.84G      | 10100400    | 9.63G      | 10000 | 200      | 1024    | 782.78  | 786.33  | 790.42  | 222.60M | 227.47M | 232.87M |
| gws_std          | 10.00s   | 1322.45 | 10560430    | 10.07G     | 10346350    | 9.87G      | 10000 | 200      | 1024    | 774.15  | 782.36  | 788.67  | 177.20M | 194.14M | 203.04M |
| hertz            | 10.00s   | 1067.92 | 7751810     | 7.39G      | 7412757     | 7.07G      | 10000 | 200      | 1024    | 570.69  | 694.13  | 768.35  | 635.13M | 912.23M | 1.08G   |
| hertz_std        | 10.00s   | 1375.26 | 11107170    | 10.59G     | 10915330    | 10.41G     | 10000 | 200      | 1024    | 786.76  | 793.69  | 801.15  | 350.11M | 382.97M | 408.16M |
| nbio_blocking    | 10.00s   | 1339.01 | 10756050    | 10.26G     | 10528960    | 10.04G     | 10000 | 200      | 1024    | 775.80  | 786.33  | 793.58  | 186.67M | 193.27M | 196.07M |
| nbio_mixed       | 10.00s   | 1346.25 | 10851860    | 10.35G     | 10604376    | 10.11G     | 10000 | 200      | 1024    | 782.75  | 787.69  | 797.30  | 312.40M | 317.24M | 323.20M |
| nbio_nonblocking | 10.00s   | 1448.52 | 10763080    | 10.26G     | 10529406    | 10.04G     | 10000 | 200      | 1024    | 665.89  | 726.91  | 759.85  | 78.96M  | 100.67M | 115.98M |
| nbio_std         | 10.00s   | 1331.54 | 10637460    | 10.14G     | 10388509    | 9.91G      | 10000 | 200      | 1024    | 766.65  | 780.19  | 793.02  | 180.99M | 197.06M | 215.91M |
| nettyws          | 10.00s   | 1372.55 | 11076090    | 10.56G     | 10866466    | 10.36G     | 10000 | 200      | 1024    | 782.77  | 791.70  | 798.94  | 166.72M | 166.72M | 166.72M |
| nhooyr           | 10.00s   | 1014.14 | 8384760     | 8.00G      | 8100432     | 7.73G      | 10000 | 200      | 1024    | 797.66  | 798.75  | 800.52  | 414.70M | 438.89M | 444.21M |
| quickws          | 10.00s   | 1388.90 | 11218530    | 10.70G     | 11004235    | 10.49G     | 10000 | 200      | 1024    | 786.78  | 792.30  | 799.47  | 121.52M | 121.52M | 121.52M |
| greatws          | 10.00s   | 1410.41 | 10252270    | 9.78G      | 10252270    | 9.78G      | 10000 | 200      | 1024    | 204.75  | 726.90  | 791.71  | 44.68M  | 44.89M  | 44.91M  |
| greatws_event    | 10.00s   | 1516.34 | 11057900    | 10.55G     | 10840560    | 10.34G     | 10000 | 200      | 1024    | 691.24  | 714.91  | 725.32  | 49.76M  | 50.89M  | 52.46M  |
----------------------------------------------------------------------------------------------------