# go-websocket-benchmark
- support 1m-connections client

## before running the test
- make sure setting the correct system env, for example:

```sh
sysctl -w net.ipv4.ip_local_port_range="1024 65535"
sysctl -w fs.file-max=2000500
sysctl -w fs.nr_open=2000500
sysctl -w net.nf_conntrack_max=2000500
ulimit -n 2000500
sysctl -w net.ipv4.tcp_mem='131072  262144  524288'
sysctl -w net.ipv4.tcp_rmem='8760  256960  4088000'
sysctl -w net.ipv4.tcp_wmem='8760  256960  4088000'
sysctl -w net.core.rmem_max=16384
sysctl -w net.core.wmem_max=16384
sysctl -w net.core.somaxconn=2048
sysctl -w net.ipv4.tcp_max_syn_backlog=2048
sysctl -w /proc/sys/net/core/netdev_max_backlog=2048
# sysctl -w net.ipv4.tcp_tw_recycle=1 # client nat tcp-handshak problem
sysctl -w net.ipv4.tcp_tw_reuse=1
```

## env
```sh
# lsb_release -a
LSB Version:    core-11.1.0ubuntu2-noarch:security-11.1.0ubuntu2-noarch
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.6 LTS
Release:        20.04
Codename:       focal

# free
              total        used        free      shared  buff/cache   available
Mem:       24969564    15656352     3422212        1880     5891000     8899604
Swap:             0           0           0

# cat /proc/cpuinfo | grep processor
processor       : 0
processor       : 1
processor       : 2
processor       : 3
processor       : 4
processor       : 5
processor       : 6
processor       : 7
processor       : 8
processor       : 9
processor       : 10
processor       : 11
processor       : 12
processor       : 13
processor       : 14
processor       : 15
```

## nbio 1m-connections-benchmark

run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/1m_conns_benchmark.sh
```

here is the result on my ubuntu vm:

```sh
--------------------------------------------------------------
BenchType  : BenchEcho
Framework  : nbio_nonblocking
TPS        : 104713
EER        : 280.33
Min        : 56.90us
Avg        : 95.36ms
Max        : 2.29s
TP50       : 62.82ms
TP75       : 65.38ms
TP90       : 89.38ms
TP95       : 409.55ms
TP99       : 637.95ms
Used       : 47.75s
Total      : 5000000
Success    : 5000000
Failed     : 0
Conns      : 1000000
Concurrency: 10000
Payload    : 1024
CPU Min    : 0.00%
CPU Avg    : 373.53%
CPU Max    : 602.33%
MEM Min    : 978.70M
MEM Avg    : 979.88M
MEM Max    : 981.14M
--------------------------------------------------------------
```

## benchmark for all frameworks
run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/benchmarkN.sh

# if you want to change the benchmark config, just read the script and edit:
# go-websocket-benchmark/script/config.sh
```

Some benchmark results:

----------------------------------------------------------------------------------------------------
20240217 18:30.45.602 [BenchEcho] Report

| Framework        | TPS    | EER    | Min      | Avg     | Max      | TP50    | TP75    | TP90    | TP95     | TP99     | Used   | Total   | Success | Failed | Conns | Concurrency | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | ------ | ------ | -------- | ------- | -------- | ------- | ------- | ------- | -------- | -------- | ------ | ------- | ------- | ------ | ----- | ----------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 315165 | 536.67 | 35.26us  | 31.65ms | 199.38ms | 29.86ms | 32.22ms | 39.23ms | 40.46ms  | 47.97ms  | 6.35s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 222.60  | 587.26  | 684.84  | 246.69M | 250.00M | 254.58M |
| gobwas           | 243224 | 341.37 | 18.21us  | 40.97ms | 185.50ms | 37.44ms | 48.56ms | 51.65ms | 53.47ms  | 65.24ms  | 8.22s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 170.84  | 712.50  | 792.70  | 354.17M | 355.64M | 356.29M |
| gorilla          | 326496 | 591.19 | 19.99us  | 30.55ms | 59.14ms  | 28.86ms | 31.45ms | 38.34ms | 39.73ms  | 42.12ms  | 6.13s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 64.93   | 552.27  | 665.82  | 248.00M | 253.46M | 258.97M |
| gws              | 314553 | 596.45 | 36.07us  | 31.68ms | 88.68ms  | 29.78ms | 32.12ms | 40.29ms | 41.78ms  | 45.18ms  | 6.36s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 0.00    | 527.37  | 731.96  | 169.85M | 175.03M | 178.14M |
| gws_std          | 341820 | 693.88 | 22.60us  | 29.17ms | 52.57ms  | 27.49ms | 29.69ms | 36.81ms | 37.87ms  | 40.52ms  | 5.85s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 1.00    | 492.62  | 645.77  | 155.82M | 172.41M | 179.48M |
| hertz            | 163101 | 483.05 | 19.23ms  | 61.08ms | 162.75ms | 55.85ms | 57.95ms | 96.87ms | 102.40ms | 110.49ms | 12.26s | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 86.95   | 337.65  | 372.85  | 494.42M | 514.22M | 542.75M |
| hertz_std        | 307792 | 467.80 | 35.48us  | 32.40ms | 204.33ms | 30.00ms | 32.57ms | 42.08ms | 43.87ms  | 60.57ms  | 6.50s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 328.54  | 657.96  | 756.67  | 321.98M | 327.27M | 332.98M |
| nbio_blocking    | 325182 | 592.22 | 25.07us  | 30.67ms | 145.95ms | 28.92ms | 30.97ms | 38.60ms | 39.71ms  | 42.42ms  | 6.15s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 79.95   | 549.09  | 662.19  | 149.98M | 161.49M | 176.11M |
| nbio_mixed       | 325072 | 582.90 | 24.49us  | 30.68ms | 210.51ms | 28.84ms | 31.20ms | 38.40ms | 39.62ms  | 44.34ms  | 6.15s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 91.95   | 557.68  | 664.77  | 169.45M | 199.96M | 212.95M |
| nbio_nonblocking | 309806 | 476.76 | 149.77us | 32.15ms | 147.32ms | 29.91ms | 33.58ms | 43.06ms | 44.86ms  | 53.20ms  | 6.46s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 320.84  | 649.81  | 719.84  | 50.43M  | 52.21M  | 53.55M  |
| nbio_std         | 322972 | 589.70 | 26.41us  | 30.88ms | 213.80ms | 29.01ms | 31.22ms | 38.72ms | 40.12ms  | 45.81ms  | 6.19s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 117.95  | 547.69  | 674.64  | 157.98M | 164.59M | 168.09M |
| nettyws          | 324709 | 590.99 | 35.93us  | 30.71ms | 162.42ms | 28.91ms | 31.17ms | 38.65ms | 39.95ms  | 43.59ms  | 6.16s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 103.81  | 549.43  | 655.52  | 160.46M | 160.52M | 160.72M |
| nhooyr           | 261454 | 347.14 | 24.74us  | 38.08ms | 158.03ms | 36.70ms | 39.61ms | 48.40ms | 50.88ms  | 64.29ms  | 7.65s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 477.75  | 753.16  | 801.70  | 368.04M | 376.53M | 381.05M |
| quickws          | 322433 | 640.16 | 31.59us  | 30.93ms | 201.50ms | 28.92ms | 31.03ms | 38.92ms | 40.19ms  | 67.55ms  | 6.20s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 104.96  | 503.68  | 619.71  | 107.23M | 107.29M | 107.49M |
| greatws          | 313727 | 542.15 | 4.07ms   | 31.74ms | 89.42ms  | 29.88ms | 35.51ms | 41.12ms | 44.05ms  | 57.34ms  | 6.37s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 222.91  | 578.68  | 656.86  | 25.38M  | 26.01M  | 26.27M  |
| greatws_event    | 305097 | 584.13 | 66.80us  | 32.64ms | 213.47ms | 30.25ms | 37.88ms | 45.88ms | 51.16ms  | 68.42ms  | 6.56s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 310.87  | 522.31  | 577.76  | 22.73M  | 23.55M  | 25.32M  |
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
20240217 18:30.45.603 [BenchRate] Report

| Framework        | Duration | EchoEER | Packet Sent | Bytes Sent | Packet Recv | Bytes Recv | Conns | SendRate | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | -------- | ------- | ----------- | ---------- | ----------- | ---------- | ----- | -------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 10.00s   | 1348.49 | 10830090    | 10.33G     | 10622960    | 10.13G     | 10000 | 200      | 1024    | 784.51  | 787.77  | 790.79  | 273.71M | 307.82M | 341.62M |
| gobwas           | 10.00s   | 803.86  | 6488670     | 6.19G      | 6146452     | 5.86G      | 10000 | 200      | 1024    | 751.57  | 764.62  | 776.83  | 508.38M | 567.42M | 618.20M |
| gorilla          | 10.00s   | 1404.76 | 11288600    | 10.77G     | 11069421    | 10.56G     | 10000 | 200      | 1024    | 786.74  | 787.99  | 789.53  | 278.08M | 290.37M | 307.37M |
| gws              | 10.00s   | 1369.24 | 11091470    | 10.58G     | 10856249    | 10.35G     | 10000 | 200      | 1024    | 790.07  | 792.87  | 795.76  | 223.86M | 237.52M | 239.50M |
| gws_std          | 10.00s   | 1387.93 | 11128320    | 10.61G     | 10901049    | 10.40G     | 10000 | 200      | 1024    | 767.74  | 785.42  | 794.72  | 185.29M | 207.61M | 223.73M |
| hertz            | 10.00s   | 1025.92 | 7173020     | 6.84G      | 6792082     | 6.48G      | 10000 | 200      | 1024    | 630.66  | 662.05  | 697.31  | 641.95M | 764.90M | 859.94M |
| hertz_std        | 10.00s   | 1398.94 | 11289950    | 10.77G     | 11077443    | 10.56G     | 10000 | 200      | 1024    | 782.77  | 791.85  | 796.77  | 353.14M | 388.65M | 424.32M |
| nbio_blocking    | 10.00s   | 1398.29 | 11232410    | 10.71G     | 10993629    | 10.48G     | 10000 | 200      | 1024    | 778.48  | 786.22  | 791.32  | 184.35M | 207.83M | 242.34M |
| nbio_mixed       | 10.00s   | 1358.25 | 10937630    | 10.43G     | 10683580    | 10.19G     | 10000 | 200      | 1024    | 781.40  | 786.57  | 789.73  | 314.59M | 319.69M | 324.21M |
| nbio_nonblocking | 10.00s   | 1331.91 | 10725610    | 10.23G     | 10487802    | 10.00G     | 10000 | 200      | 1024    | 780.70  | 787.43  | 793.78  | 216.24M | 243.82M | 268.86M |
| nbio_std         | 10.00s   | 1354.46 | 10895730    | 10.39G     | 10662059    | 10.17G     | 10000 | 200      | 1024    | 784.75  | 787.18  | 788.73  | 194.48M | 199.75M | 216.65M |
| nettyws          | 10.00s   | 1416.68 | 11430610    | 10.90G     | 11197374    | 10.68G     | 10000 | 200      | 1024    | 788.81  | 790.40  | 794.57  | 163.38M | 163.38M | 163.38M |
| nhooyr           | 10.00s   | 991.20  | 8215140     | 7.83G      | 7919127     | 7.55G      | 10000 | 200      | 1024    | 797.67  | 798.95  | 801.29  | 400.12M | 451.50M | 502.07M |
| quickws          | 10.00s   | 1410.44 | 11348850    | 10.82G     | 11133018    | 10.62G     | 10000 | 200      | 1024    | 783.20  | 789.33  | 793.59  | 108.26M | 108.26M | 108.26M |
| greatws          | 10.00s   | 1305.77 | 10234710    | 9.76G      | 9999098     | 9.54G      | 10000 | 200      | 1024    | 746.53  | 765.76  | 776.77  | 23.23M  | 23.65M  | 24.01M  |
| greatws_event    | 10.00s   | 1438.20 | 10192270    | 9.72G      | 9935866     | 9.48G      | 10000 | 200      | 1024    | 678.63  | 690.85  | 702.37  | 22.48M  | 24.70M  | 26.89M  |
----------------------------------------------------------------------------------------------------