# go-websocket-benchmark
- support 1m-connections client

## before running the test
- make sure setting the correct system env, for example:

```sh
sysctl -w net.ipv4.ip_local_port_range="1024 65535"
sysctl -w fs.file-max=2000500
sysctl -w fs.nr_open=2000500
sysctl -w net.nf_conntrack_max=2000500
ulimit -n 2000500
sysctl -w net.ipv4.tcp_mem='131072  262144  524288'
sysctl -w net.ipv4.tcp_rmem='8760  256960  4088000'
sysctl -w net.ipv4.tcp_wmem='8760  256960  4088000'
sysctl -w net.core.rmem_max=16384
sysctl -w net.core.wmem_max=16384
sysctl -w net.core.somaxconn=2048
sysctl -w net.ipv4.tcp_max_syn_backlog=2048
sysctl -w /proc/sys/net/core/netdev_max_backlog=2048
# sysctl -w net.ipv4.tcp_tw_recycle=1 # client nat tcp-handshak problem
sysctl -w net.ipv4.tcp_tw_reuse=1
```

## env
```sh
# lsb_release -a
LSB Version:    core-11.1.0ubuntu2-noarch:security-11.1.0ubuntu2-noarch
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.6 LTS
Release:        20.04
Codename:       focal

# free
              total        used        free      shared  buff/cache   available
Mem:       24969564    15656352     3422212        1880     5891000     8899604
Swap:             0           0           0

# cat /proc/cpuinfo | grep processor
processor       : 0
processor       : 1
processor       : 2
processor       : 3
processor       : 4
processor       : 5
processor       : 6
processor       : 7
processor       : 8
processor       : 9
processor       : 10
processor       : 11
processor       : 12
processor       : 13
processor       : 14
processor       : 15
```

## nbio 1m-connections-benchmark

run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/1m_conns_benchmark.sh
```

here is the result on my ubuntu vm:

```sh
--------------------------------------------------------------
BenchType  : BenchEcho
Framework  : nbio_nonblocking
TPS        : 104713
EER        : 280.33
Min        : 56.90us
Avg        : 95.36ms
Max        : 2.29s
TP50       : 62.82ms
TP75       : 65.38ms
TP90       : 89.38ms
TP95       : 409.55ms
TP99       : 637.95ms
Used       : 47.75s
Total      : 5000000
Success    : 5000000
Failed     : 0
Conns      : 1000000
Concurrency: 10000
Payload    : 1024
CPU Min    : 0.00%
CPU Avg    : 373.53%
CPU Max    : 602.33%
MEM Min    : 978.70M
MEM Avg    : 979.88M
MEM Max    : 981.14M
--------------------------------------------------------------
```

## benchmark for all frameworks
run:
```sh
git clone https://github.com/lesismal/go-websocket-benchmark.git
cd go-websocket-benchmark
./script/benchmarkN.sh

# if you want to change the benchmark config, just read the script and edit:
# go-websocket-benchmark/script/config.sh
```

Some benchmark results:

----------------------------------------------------------------------------------------------------
20240217 18:15.22.834 [BenchEcho] Report

| Framework        | TPS    | EER    | Min     | Avg     | Max      | TP50    | TP75    | TP90    | TP95     | TP99     | Used   | Total   | Success | Failed | Conns | Concurrency | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | ------ | ------ | ------- | ------- | -------- | ------- | ------- | ------- | -------- | -------- | ------ | ------- | ------- | ------ | ----- | ----------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 315149 | 534.13 | 27.98us | 31.64ms | 72.96ms  | 29.88ms | 32.95ms | 39.17ms | 40.60ms  | 46.97ms  | 6.35s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 221.91  | 590.03  | 694.85  | 249.67M | 252.52M | 256.10M |
| gobwas           | 243409 | 342.73 | 16.29us | 40.94ms | 251.41ms | 37.33ms | 47.86ms | 51.43ms | 53.75ms  | 77.23ms  | 8.22s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 168.93  | 710.21  | 792.81  | 350.06M | 357.17M | 360.01M |
| gorilla          | 325989 | 599.75 | 29.74us | 30.60ms | 104.28ms | 28.85ms | 31.33ms | 38.39ms | 39.66ms  | 43.58ms  | 6.14s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 74.89   | 543.54  | 674.89  | 246.99M | 252.20M | 257.07M |
| gws              | 323482 | 562.68 | 27.91us | 30.84ms | 140.30ms | 28.98ms | 31.27ms | 38.80ms | 40.27ms  | 44.40ms  | 6.18s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 120.91  | 574.90  | 678.85  | 169.80M | 172.84M | 174.65M |
| gws_std          | 328955 | 629.73 | 25.00us | 30.31ms | 176.66ms | 28.42ms | 30.54ms | 38.01ms | 39.31ms  | 44.63ms  | 6.08s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 39.98   | 522.37  | 652.73  | 164.40M | 184.17M | 194.32M |
| hertz            | 160504 | 474.47 | 16.45ms | 62.08ms | 164.03ms | 56.86ms | 59.34ms | 97.09ms | 101.78ms | 112.65ms | 12.46s | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 161.78  | 338.28  | 372.94  | 493.33M | 513.52M | 553.70M |
| hertz_std        | 308083 | 469.20 | 31.98us | 32.36ms | 60.07ms  | 30.41ms | 32.99ms | 41.57ms | 43.49ms  | 45.95ms  | 6.49s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 344.47  | 656.61  | 742.81  | 324.16M | 329.25M | 334.58M |
| nbio_blocking    | 326744 | 614.57 | 31.07us | 30.53ms | 109.43ms | 28.70ms | 31.14ms | 38.65ms | 40.16ms  | 44.26ms  | 6.12s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 67.85   | 531.67  | 666.75  | 148.21M | 159.87M | 173.07M |
| nbio_mixed       | 323512 | 576.70 | 27.43us | 30.83ms | 188.39ms | 29.06ms | 31.49ms | 38.49ms | 39.91ms  | 44.80ms  | 6.18s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 106.77  | 560.97  | 666.85  | 168.70M | 199.74M | 213.24M |
| nbio_nonblocking | 198197 | 611.93 | 2.64ms  | 50.26ms | 108.94ms | 49.74ms | 52.17ms | 56.32ms | 59.17ms  | 73.95ms  | 10.09s | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 29.96   | 323.89  | 372.91  | 44.45M  | 51.44M  | 56.58M  |
| nbio_std         | 331860 | 651.42 | 26.76us | 30.04ms | 111.00ms | 28.29ms | 30.65ms | 37.58ms | 38.77ms  | 44.15ms  | 6.03s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 0.00    | 509.44  | 639.85  | 177.98M | 178.85M | 179.63M |
| nettyws          | 325842 | 644.32 | 29.87us | 30.60ms | 200.83ms | 28.50ms | 30.73ms | 38.31ms | 39.70ms  | 75.53ms  | 6.14s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 71.90   | 505.71  | 631.45  | 149.33M | 149.79M | 150.36M |
| nhooyr           | 262762 | 348.30 | 22.68us | 37.92ms | 146.50ms | 36.64ms | 39.32ms | 47.84ms | 49.96ms  | 55.98ms  | 7.61s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 486.04  | 754.40  | 801.81  | 367.12M | 378.34M | 390.64M |
| quickws          | 337630 | 698.95 | 24.92us | 29.54ms | 55.44ms  | 27.91ms | 29.80ms | 37.22ms | 38.14ms  | 39.92ms  | 5.92s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 1.00    | 483.05  | 613.44  | 111.82M | 111.82M | 111.82M |
| greatws          | 312894 | 533.68 | 4.67ms  | 31.82ms | 99.10ms  | 29.80ms | 34.77ms | 41.49ms | 45.75ms  | 59.83ms  | 6.39s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 252.82  | 586.30  | 663.78  | 22.44M  | 23.22M  | 23.59M  |
| greatws_event    | 302261 | 580.01 | 64.84us | 32.96ms | 206.17ms | 30.82ms | 38.08ms | 46.26ms | 52.09ms  | 64.12ms  | 6.62s  | 2000000 | 2000000 | 0      | 10000 | 10000       | 1024    | 347.60  | 521.13  | 562.84  | 24.16M  | 25.46M  | 26.52M  |
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
20240217 18:15.22.835 [BenchRate] Report

| Framework        | Duration | EchoEER | Packet Sent | Bytes Sent | Packet Recv | Bytes Recv | Conns | SendRate | Payload | CPU Min | CPU Avg | CPU Max | MEM Min | MEM Avg | MEM Max |
| ---------------- | -------- | ------- | ----------- | ---------- | ----------- | ---------- | ----- | -------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- |
| fasthttp         | 10.00s   | 1377.21 | 11121660    | 10.61G     | 10872629    | 10.37G     | 10000 | 200      | 1024    | 786.79  | 789.47  | 793.46  | 275.70M | 310.68M | 345.98M |
| gobwas           | 10.00s   | 679.33  | 5537210     | 5.28G      | 5195976     | 4.96G      | 10000 | 200      | 1024    | 715.85  | 764.87  | 783.84  | 520.16M | 569.22M | 601.66M |
| gorilla          | 10.00s   | 1415.16 | 11436060    | 10.91G     | 11202011    | 10.68G     | 10000 | 200      | 1024    | 788.70  | 791.57  | 796.44  | 276.10M | 312.20M | 348.21M |
| gws              | 10.00s   | 1382.60 | 11202550    | 10.68G     | 10986930    | 10.48G     | 10000 | 200      | 1024    | 790.76  | 794.66  | 796.29  | 221.95M | 225.55M | 229.35M |
| gws_std          | 10.00s   | 1389.92 | 11157480    | 10.64G     | 10923891    | 10.42G     | 10000 | 200      | 1024    | 771.79  | 785.94  | 792.74  | 191.70M | 203.16M | 226.55M |
| hertz            | 10.00s   | 1000.09 | 7308780     | 6.97G      | 6927580     | 6.61G      | 10000 | 200      | 1024    | 660.80  | 692.69  | 743.71  | 642.89M | 744.10M | 838.55M |
| hertz_std        | 10.00s   | 1382.79 | 11200200    | 10.68G     | 10977615    | 10.47G     | 10000 | 200      | 1024    | 785.79  | 793.87  | 797.80  | 354.65M | 389.53M | 424.80M |
| nbio_blocking    | 10.00s   | 1408.40 | 11350690    | 10.82G     | 11119699    | 10.60G     | 10000 | 200      | 1024    | 783.56  | 789.52  | 795.73  | 181.96M | 190.11M | 198.70M |
| nbio_mixed       | 10.00s   | 1393.09 | 11225040    | 10.71G     | 10957940    | 10.45G     | 10000 | 200      | 1024    | 781.72  | 786.59  | 790.67  | 313.29M | 321.51M | 328.86M |
| nbio_nonblocking | 10.00s   | 1318.65 | 10373420    | 9.89G      | 10133716    | 9.66G      | 10000 | 200      | 1024    | 751.73  | 768.49  | 780.47  | 117.65M | 130.17M | 142.69M |
| nbio_std         | 10.00s   | 1391.13 | 11157300    | 10.64G     | 10945035    | 10.44G     | 10000 | 200      | 1024    | 772.44  | 786.78  | 795.40  | 200.29M | 208.25M | 225.62M |
| nettyws          | 10.00s   | 1398.83 | 11333040    | 10.81G     | 11102326    | 10.59G     | 10000 | 200      | 1024    | 790.32  | 793.69  | 796.78  | 165.68M | 165.68M | 165.68M |
| nhooyr           | 10.00s   | 966.32  | 8014900     | 7.64G      | 7721586     | 7.36G      | 10000 | 200      | 1024    | 797.81  | 799.07  | 800.64  | 415.38M | 465.81M | 515.16M |
| quickws          | 10.00s   | 1407.88 | 11362080    | 10.84G     | 11148334    | 10.63G     | 10000 | 200      | 1024    | 785.62  | 791.85  | 799.77  | 112.62M | 112.62M | 112.62M |
| greatws          | 10.00s   | 1406.39 | 9979450     | 9.52G      | 9979450     | 9.52G      | 10000 | 200      | 1024    | 197.87  | 709.58  | 773.66  | 20.47M  | 20.91M  | 21.41M  |
| greatws_event    | 10.00s   | 1435.02 | 10153670    | 9.68G      | 9896655     | 9.44G      | 10000 | 200      | 1024    | 675.13  | 689.65  | 710.81  | 24.98M  | 27.06M  | 29.39M  |
----------------------------------------------------------------------------------------------------